#!/bin/bash
#============================================================================
# Title: brewfile
# Usage: brewfile [ -c | --clean | -d | --dump | -l | --list | -h | --help | -s | --save ]
#
# Description:
# Homebrew Brewfile manager
#============================================================================

while :; do
	case $1 in
	-c | --clean)
		chirp --info "Running bundle clean"
		chirp --process-item "Pausing brew-dump launch agent"
		launchctl unload ~/Library/LaunchAgents/com.raf.brew-dump.plist
		chirp --process-item "Uninstalling uncommitted packages"
		brew bundle cleanup --force --file "$HOMEBREW_BREWFILE" --describe
		chirp --process-item "Restarting brew-dump launch agent"
		launchctl load ~/Library/LaunchAgents/com.raf.brew-dump.plist
		chirp --success "Cleanup complete"
		break
		;;
	-d | --dump)
		chirp --process-title "Dumping Homebrew bundle"
		brew bundle dump --force --file="$HOMEBREW_BREWFILE" --describe --taps --brews --casks --mas
		chirp --success "Dump complete -> $HOMEBREW_BREWFILE"
		break
		;;
	-i | --install)
		chirp --process-title "Installing Homebrew bundle"
		brew bundle --quiet --no-upgrade --file="$HOMEBREW_BREWFILE"
		break
		;;
	-l | --list)
		chirp --info "Your Brewfile has uncommitted changes"
		git --no-pager -C "$DOTFILES" diff --unified=0 "$HOMEBREW_BREWFILE" |
			grep --color=never '^[+|-][^+|-]' |
			sed "s/^+/$(tput setaf 2)Added$(tput sgr0) /" |
			sed "s/^-/$(tput setaf 1)Removed$(tput sgr0) /" |
			GREP_COLOR='01;34' grep --color -e '"[^"]\+"'
		break
		;;
	-h | --help)
		chirp --info "Manage your Homebrew Brewfile"
		echo
		chirp --alt "Options"
		echo
		chirp --option "-c, --clean" "Uninstall any brews that aren't in the brewfile"
		chirp --option "-d, --dump" "Dump added/removed brews"
		chirp --option "-h, --help" "Show help"
		chirp --option "-s, --save" "Git commit bundle changes"
		chirp --option "-w, --why" "List dependencies"
		chirp --option "-i, --install" "Install brews from Brewfile"
		chirp --option "-l, --list" "List uncommitted changes"
		break
		;;
	-s | --save)
		(
			cd "$DOTFILES" || exit
			chirp --success "Your Brewfile is up to date"
			if git diff -s --exit-code "$HOMEBREW_BREWFILE"; then
				commit_msg=$(
					git --git-dir="$DOTFILES"/.git --no-pager -C "$DOTFILES" diff --unified=0 "$HOMEBREW_BREWFILE" |
						grep --color=never '^[+|-][^+|-]' |
						sed "s/^+/Add /" |
						sed "s/^-/Remove /"
				)
				git --git-dir="$DOTFILES"/.git add "$HOMEBREW_BREWFILE"
				git --git-dir="$DOTFILES"/.git commit -m "$commit_msg"
				chirp --success "Bundle changes committed"
			fi
		)
		break
		;;
	-w | --why)
		brew list -1 --formula | while read -r cask; do
			echo -ne "\x1B[1;34m $cask \x1B[0m"
			brew uses "$cask" --installed | awk '{printf(" %s ", $0)}'
			echo ""
		done
		;;
	*)
		b --help
		break
		;;
	esac
	shift
done
